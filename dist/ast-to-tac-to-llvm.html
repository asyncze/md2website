<html lang='en'><head><title>AST to TAC to LLVM</title><link rel='stylesheet' href='main.min.css'><script src='main.min.js'></script></head><body><nav><p><a href="index.html">home</a> <a href="posts.html">posts</a> <a href="programming.html">programming</a></p></nav><div class='page'><h1>AST to TAC to LLVM</h1>
<p><em>July 2023</em> <a href="programming.html#python">Python</a> <a href="programming.html#compilers">Compilers</a></p>
<pre><code class="language-python">from mako.template import Template

def gen_tac(ast, tmp_counter):
    if isinstance(ast, int):
        return f&quot;t{tmp_counter} = {ast}&quot;, f&quot;t{tmp_counter}&quot;, tmp_counter + 1
    elif isinstance(ast, list):
        op = ast[0]
        left, left_var, tmp_counter = gen_tac(ast[1], tmp_counter)
        right, right_var, tmp_counter = gen_tac(ast[2], tmp_counter)
        tmp_var = f&quot;t{tmp_counter}&quot;
        result = f&quot;{tmp_var} = {left_var} {op} {right_var}&quot;
        return f&quot;{left}\n{right}\n{result}&quot;, tmp_var, tmp_counter + 1
    else:
        raise Exception(&quot;unknown node&quot;)

def tac_to_llvm(tac):
    code = []
    var_map = {}

    code.append(&quot;define i32 @main(i32) {&quot;)

    for line in tac.strip().split('\n'):
        parts = line.split(' ')
        destination_var = parts[0]
        operation = parts[1]
        operands = parts[2:]

        if len(parts) == 3 and operation == '=':
            if operands and operands[0].isdigit():
                code.append(f&quot;\t%{destination_var} = add i32 {operands[0]}, 0&quot;)
            else:
                code.append(f&quot;\t%{destination_var} = add i32 %{var_map[operands[0]]}, 0&quot;)
            var_map[destination_var] = destination_var
        else:
            # replace assignment with operation
            operation = parts[3]
            if operands[0].isdigit():
                op1 = f&quot;{operands[0]}&quot;
            else:
                op1 = f&quot;%{var_map[operands[0]]}&quot;
            if operands[2].isdigit():
                op2 = f&quot;{operands[2]}&quot;
            else:
                op2 = f&quot;%{var_map[operands[2]]}&quot;

            if operation == '+':
                code.append(f&quot;\t%{destination_var} = add i32 {op1}, {op2}&quot;)
            elif operation == '-':
                code.append(f&quot;\t%{destination_var} = sub i32 {op1}, {op2}&quot;)
            elif operation == '*':
                code.append(f&quot;\t%{destination_var} = mul i32 {op1}, {op2}&quot;)
            elif operation == '/':
                code.append(f&quot;\t%{destination_var} = sdiv i32 {op1}, {op2}&quot;)
            else:
                raise ValueError(f&quot;Unsupported operation: {operation}&quot;)

            var_map[destination_var] = destination_var

    code.append(f&quot;\tret i32 %{var_map[destination_var]}&quot;)
    code.append(&quot;}&quot;)

    return '\n'.join(code)
</code></pre>
<pre><code class="language-python">ast = [&quot;+&quot;, 2, [&quot;*&quot;, 3, 4]]
tac = gen_tac(ast, 1)[0]
# t1 = 2
# t2 = 3
# t3 = 4
# t4 = t2 * t3
# t5 = t1 + t4

print(tac_to_llvm(tac))
# define i32 @main(i32) {
#     %t1 = add i32 2, 0
#     %t2 = add i32 3, 0
#     %t3 = add i32 4, 0
#     %t4 = mul i32 %t2, %t3
#     %t5 = add i32 %t1, %t4
#     ret i32 %t5
# }
</code></pre></div><div id='footer'><p>[<a id='invert'>light|dark</a>]</p><p><span class='small'>DOM loaded in <span id='dom_time'></span>, page loaded in <span id='load_time'></span></span></p></div></body></html>